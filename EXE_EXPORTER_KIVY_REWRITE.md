# EXE Exporter - Complete Rewrite Using Kivy Runtime

## Summary

The EXE exporter at `/home/gabe/Dropbox/pygm2/export/exe/exe_exporter.py` has been **completely rewritten** to use the Kivy-based runtime instead of the incomplete pygame runtime.

## What Changed

### Old Approach (Removed)
- Used pygame-based runtime (incomplete)
- Copied project file and runtime modules
- Created basic pygame game launcher
- Limited GameMaker compatibility

### New Approach (Implemented)
- **Uses KivyExporter** to generate complete Kivy game
- **80% GameMaker 7.0 compatible** (same as Kivy exporter)
- Bundles Kivy game with PyInstaller
- Includes all game logic, objects, scenes, and assets

## Architecture

### Workflow

```
1. Load project data from .pgm file
2. Use KivyExporter to generate game/ directory
   ├── game/main.py (Kivy app entry point)
   ├── game/objects/ (GameObject classes)
   ├── game/scenes/ (Room classes)
   ├── game/assets/ (Images, sounds)
   └── game/utils.py (Helper functions)
3. Create launcher script (game_launcher.py)
4. Create PyInstaller spec file
5. Bundle everything into standalone EXE
6. Copy to output directory
```

### Key Components

#### 1. KivyExporter Integration (`_generate_kivy_game`)
```python
def _generate_kivy_game(self, build_dir: Path) -> bool:
    from export.Kivy.kivy_exporter import KivyExporter

    exporter = KivyExporter(self.project_data, project_dir, build_dir)
    success = exporter.export()

    # Verifies game/ directory and main.py were created
    return success
```

#### 2. Launcher Script (`_create_launcher_script`)
Creates `game_launcher.py` that:
- Detects PyInstaller frozen executable (`sys._MEIPASS`)
- Sets up proper paths for bundled game
- Changes to game directory
- Imports and runs `GameApp` from Kivy game

```python
if getattr(sys, 'frozen', False):
    base_path = sys._MEIPASS  # PyInstaller temp directory
else:
    base_path = os.path.dirname(os.path.abspath(__file__))

game_dir = os.path.join(base_path, 'game')
os.chdir(game_dir)
sys.path.insert(0, game_dir)

from main import GameApp
GameApp().run()
```

#### 3. PyInstaller Spec File (`_create_spec_file`)
- Includes entire `game/` directory as data
- Bundles all Kivy dependencies
- Excludes unnecessary packages (PySide6, PyQt, matplotlib, etc.)
- Supports custom icon
- Configurable debug/console mode
- Optimized with UPX compression

### GameMaker 7.0 Features Supported

Since this uses the Kivy exporter, it supports **80% of GameMaker 7.0**:

**Fully Supported:**
- ✅ Objects with sprites, properties (solid, visible, persistent)
- ✅ Rooms with instances
- ✅ Events: Create, Step, Begin Step, End Step, Destroy, Draw
- ✅ Keyboard events (arrow keys, WASD)
- ✅ Collision events (with specific objects)
- ✅ Alarm events (12 alarms per instance)
- ✅ Movement system: hspeed, vspeed, speed, direction
- ✅ Gravity and friction
- ✅ Grid-based movement and snapping
- ✅ Bidirectional speed/direction synchronization
- ✅ Frame-independent movement (dt-based)
- ✅ Optimized collision detection (O(n²/2))
- ✅ Proper GameMaker event execution order

**Action Types Supported:**
- Movement: set_hspeed, set_vspeed, set_speed, set_direction, stop_movement
- Grid: snap_to_grid, if_on_grid
- Instance: destroy_instance, create_instance
- Control: if conditions, stop_if_no_keys
- Alarms: set_alarm

## Benefits

### 1. Complete Runtime
- Full game logic implementation
- Proper event system
- Accurate GameMaker behavior

### 2. Cross-Platform Foundation
- Kivy is cross-platform
- Same codebase could target Linux/Mac with minor changes
- Mobile export possible via Buildozer

### 3. Maintainability
- Reuses proven KivyExporter code
- Single source of truth for game logic
- No duplicate runtime implementations

### 4. Performance
- Optimized collision detection
- Frame-independent movement
- Image caching
- Kivy's GPU-accelerated rendering

## Usage

```python
from export.exe.exe_exporter import ExeExporter

exporter = ExeExporter()

settings = {
    'include_debug': False,  # Hide console window
    'optimize': True,        # Enable UPX compression
    'icon_path': None,       # Optional custom icon
}

success = exporter.export_project(
    project_path='path/to/game.pgm',
    output_path='path/to/output/directory',
    settings=settings
)
```

## Dependencies

### Required Python Packages
```
pyinstaller>=5.0
kivy>=2.1.0
Pillow>=9.0  # For image loading in Kivy
```

### Export Process Dependencies
1. **KivyExporter** (`export/Kivy/kivy_exporter.py`)
2. **ActionConverter** (`export/Kivy/action_converter.py`)

## File Structure

### Generated Build Directory
```
build_temp_exe/
├── game_launcher.py          # Launcher script
├── game.spec                  # PyInstaller spec
├── game/                      # Generated by KivyExporter
│   ├── main.py               # Kivy app
│   ├── utils.py              # Helper functions
│   ├── objects/              # Object classes
│   │   ├── base_object.py   # GameObject base class
│   │   ├── obj_player.py    # Example object
│   │   └── ...
│   ├── scenes/               # Room/scene classes
│   │   ├── room0.py         # Example room
│   │   └── ...
│   └── assets/               # Game assets
│       ├── images/
│       └── sounds/
├── build/                     # PyInstaller build artifacts
└── dist/                      # Final executable
    └── GameName.exe          # Standalone game
```

### Output Directory
```
output/
└── GameName.exe              # Ready to distribute!
```

## Progress Updates

The exporter emits Qt signals for progress tracking:

```python
exporter.progress_update.connect(on_progress)  # (int, str) - percentage, message
exporter.export_complete.connect(on_complete)  # (bool, str) - success, message
```

Progress stages:
- 10% - Checking PyInstaller
- 20% - Creating build directory
- 30% - Generating Kivy game
- 50% - Creating launcher script
- 60% - Creating PyInstaller spec
- 70% - Building executable
- 90% - Copying to output
- 95% - Cleanup
- 100% - Complete

## Error Handling

The exporter validates:
- PyInstaller is installed
- KivyExporter succeeds
- game/ directory is created
- main.py exists
- PyInstaller build succeeds

All errors are reported via the `export_complete` signal with detailed messages.

## Testing

To test the exporter:

```python
# 1. Create a test project
# 2. Export to EXE
exporter = ExeExporter()
success = exporter.export_project(
    'test_project.pgm',
    'test_output',
    {'include_debug': True}  # Enable console for debugging
)

# 3. Run the generated EXE
# test_output/GameName.exe
```

## Future Improvements

### Potential Enhancements
1. **Icon Support** - Add automatic icon conversion/embedding
2. **Multi-File Mode** - Option for directory-based output (smaller updates)
3. **Code Signing** - Windows authenticode signing
4. **Installer Creation** - NSIS/Inno Setup integration
5. **Linux/Mac Support** - PyInstaller works on all platforms
6. **Version Info** - Embed version metadata in EXE

### Known Limitations
1. **File Size** - Single EXE includes entire Kivy (20-50MB)
2. **Startup Time** - PyInstaller extraction on first run (1-2 seconds)
3. **Antivirus** - Some AVs flag PyInstaller executables (false positive)

## Migration Notes

### For Projects Using Old EXE Exporter
- No project file changes needed
- Just re-export with new exporter
- Games will use Kivy runtime automatically
- Much better GameMaker compatibility

### Breaking Changes
- None - The API is identical
- Same signals and progress updates
- Same settings dictionary

## Summary

The EXE exporter has been transformed from a basic pygame wrapper into a **production-ready, GameMaker 7.0-compatible runtime** by leveraging the battle-tested Kivy exporter and bundling it with PyInstaller. This provides:

✅ **80% GameMaker 7.0 compatibility**
✅ **Complete event system**
✅ **Optimized performance**
✅ **Standalone EXE distribution**
✅ **Professional game runtime**

The old pygame-based approach has been completely replaced with this superior solution.
